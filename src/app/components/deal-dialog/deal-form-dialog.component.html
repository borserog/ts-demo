<div cdkOverlayOrigin class="modal-box max-w-[800px] w-full m-auto">
  <h2 [ngPlural]="dealsForm.controls.length" class="font-bold text-lg mb-4">
    <ng-template ngPluralCase="=1"> Add New Deal</ng-template>
    <ng-template ngPluralCase="other"> Add {{ dealsForm.controls.length }} New Deals</ng-template>
  </h2>
  <form [formGroup]="form" class="max-h-[40vh] overflow-auto flex flex-col gap-2 mb-2">
    <cdk-accordion #accordion="cdkAccordion" formArrayName="dealsForm" multi="true">
      @for (dealForm of dealsForm.controls; track dealForm; let index = $index) {
        <cdk-accordion-item role="button"
                            expanded="true"
                            class="p-0"
                            #accordionItem="cdkAccordionItem"
                            [attr.id]="'accordion-header-' + index"
                            [attr.aria-expanded]="accordionItem.expanded"
                            [attr.aria-controls]="'accordion-body-' + index"
                            [formGroup]="castFormGroup(dealForm)">
          <div class="shadow-sm border-[1px] rounded border-slate-300"
          >

            <div class="p-4"
                 [ngClass]="{'bg-error text-red-100': dealForm.invalid, 'bg-success text-green-100': dealForm.valid}"
                 (click)="accordionItem.toggle()">
              {{ dealForm.invalid ? 'Invalid' : 'Good to go' }}
            </div>
            <div role="region" class="grid grid-cols-2 gap-4 bg-slate-100 text-sm p-4"
                 [style.display]="accordionItem.expanded ? '' : 'none'"
                 [attr.id]="'accordion-body-' + index"
                 [attr.aria-labelledby]="'accordion-header-' + index">
              <label class="form-control w-full">
                <p class="font-bold mb-1">Deal Name</p>
                <input
                  formControlName="name"
                  autocomplete="off"
                  class="input input-bordered input-xs w-full"
                  maxlength="30"
                  minlength="1"
                  name="name"
                  placeholder="Type here"
                  type="text" />
              </label>

              <label class="form-control w-full">
                <p class="font-bold mb-1">Address</p>
                <input
                  formControlName="address"
                  autocomplete="off"
                  class="input input-bordered input-xs w-full"
                  maxlength="30"
                  minlength="1"
                  name="address"
                  placeholder="Type here"
                  type="text" />
              </label>

              <label class="form-control w-full">
                <p class="font-bold mb-1">Purchase Price</p>
                <input
                  formControlName="purchasePrice"
                  autocomplete="off"
                  class="input input-bordered input-xs w-full"
                  maxlength="30"
                  minlength="1"
                  name="purchase-price"
                  placeholder="Type here"
                  type="number" />
              </label>

              <label class="form-control w-full">
                <p class="font-bold mb-1">NOI</p>
                <input
                  formControlName="netOperationalIncome"
                  autocomplete="off"
                  class="input input-bordered input-xs w-full"
                  maxlength="30"
                  minlength="1"
                  name="noi"
                  placeholder="Type here"
                  type="number" />
              </label>

              <label class="form-control w-full">
                <p class="font-bold mb-1">Type</p>
                <select formControlName="type" class="select select-bordered select-xs w-full max-w-xs">
                  <option [value]="''" disabled selected>Select Deal type</option>
                  @for (entry of Object.values(dealTypes); track entry) {
                    <option [value]="entry">{{ entry }}</option>
                  }
                </select>
              </label>
            </div>
          </div>
        </cdk-accordion-item>
      }

    </cdk-accordion>
  </form>
  <p class="text-end">{{ dealsForm.length }}/5</p>

  <!-- if there is a button in form, it will close the modal -->
  <!--      if it is an adding operation -->
  <div class="flex place-content-center m-8 gap-2">
    <button (click)="addNewDealForm()" [disabled]="dealsForm.length >= 5" class="btn btn-outline btn-sm">Add
    </button>
    <button (click)="accordion.openAll()" class="btn btn-outline btn-sm">
      Open All
    </button>
    <button (click)="accordion.closeAll()" class="btn btn-outline btn-sm">
      Close All
    </button>
  </div>

  <div class="flex flex-row place-content-end gap-2">
    <button (click)="saveChanges()"
            [disabled]="form.invalid"
            class="btn btn-success"
    >
      Send
    </button>
    <button (click)="closeDialog()" class="btn">Close</button>
  </div>
</div>
